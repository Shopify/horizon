{% comment %}
  Variant Family snippet for Horizon 3.0.1
  Uses closest.product to safely access product metafields
  Displays a row of sibling products if metafield exists
  Shows fallback text if no products are assigned
{% endcomment %}

{% assign current_product = closest.product | default: product %}
{% assign family_products = current_product.metafields.custom.variant_family.value %}

{% if family_products != blank %}
  <div class="variant-family" role="group" aria-label="Choose model">
    {% comment %}
      Render current product first, then others, in a single loop
    {% endcomment %}
    {% for family_product in family_products %}
      {% if family_product.id == current_product.id %}
        {% assign current_first = family_product %}
      {% endif %}
    {% endfor %}

    {% comment %}
      Output current product first
    {% endcomment %}
    <a
      href="{{ current_first.url }}"
      class="variant-family__item active"
      aria-current="true"
      title="{{ current_first.title }}"
    >
      {% if current_first.featured_image %}
        <img
          src="{{ current_first.featured_image | img_url: '100x100' }}"
          alt="{{ current_first.title }}"
          width="50"
          height="50"
        >
      {% else %}
        <span class="variant-swatch" aria-label="{{ current_first.title }}"></span>
      {% endif %}
    </a>

    {% comment %}
      Then output the other products in a single loop without duplicating HTML
    {% endcomment %}
    {% for family_product in family_products %}
      {% unless family_product.id == current_product.id %}
        <a
          href="{{ family_product.url }}"
          class="variant-family__item"
          aria-current="false"
          title="{{ family_product.title }}"
        >
          {% if family_product.featured_image %}
            <img
              src="{{ family_product.featured_image | img_url: '100x100' }}"
              alt="{{ family_product.title }}"
              width="50"
              height="50"
            >
          {% else %}
            <span class="variant-swatch" aria-label="{{ family_product.title }}"></span>
          {% endif %}
        </a>
      {% endunless %}
    {% endfor %}
  </div>

  <style>
    .variant-family {
      display: flex;
      gap: 1px;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .variant-family__item {
      display: block;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 2px;
      transition: border-color 0.2s;
    }

    .variant-family__item.active {
      border-color: #000;
    }

    .variant-family__item image,
    .variant-swatch {
      width: 25px;
      height: 25px;
      object-fit: cover;
      border-radius: 4px;
      display: block;
    }

    .variant-swatch {
      background-color: #ccc;
      display: inline-block;
    }

    .variant-family__item:focus {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    .variant-family__item:hover {
      border-color: #555;
    }
  </style>

{% else %}
  <div class="variant-family-empty" style="margin-top:1rem; color:#555; font-style:italic;">
    Tuotteita ei määritelty
  </div>
{% endif %}
